2026-01-08
- Link público: endereço obrigatório para tipo_negocio=faxina e envio via p_extras
- Edge Function payments: aceita cliente_endereco e persiste em p_extras.endereco
- RPC public_create_agendamento_publico: suporte a p_extras (jsonb) e coluna agendamentos.extras
- Página pública (config): tipo_negocio fica bloqueado após primeira definição não-vazia
- Agenda (usuário/funcionário): exibe extras.endereco quando presente no agendamento
- WhatsApp: variável {cliente_endereco} disponível nos templates e preenchida por agendamentos.extras.endereco (prioridade sobre unidade/endereço do negócio)
- Link público: regras por serviço (buffers/antecedência/janela) aplicadas em slots e criação
- RPC public_get_ocupacoes: considera buffer_antes_min/buffer_depois_min por serviço
- Página pública: maxDays/minLeadMinutes exibidos conforme regras do serviço selecionado
- Página pública: email opcional (extras.email) para fallback de confirmação
- Cliente (detalhes): edição de extras (endereco/placa/email) por agendamento
- WhatsApp (confirmação): fallback real por e-mail via Resend quando necessário
- Serviços: suporte a dia_inteiro e capacidade diária de diárias (1 ou 2)
- Link público: calendário responsivo para selecionar dia em serviços dia_inteiro
- RPC public_get_slots_publicos: dia_inteiro usa capacidade_dia_inteiro e bloqueios reais
- RPC public_create_agendamento_publico: dia_inteiro reserva expediente completo e respeita capacidade
- Lint: removido setState em useEffect (capacidadeDiaInteiro e mês do calendário)
- Página pública: hora de dia_inteiro é derivada de diaInteiroDisponibilidade[data]

2026-01-11
- Funcionários: fallback quando coluna capacidade_dia_inteiro não existe (carrega sem ela e exibe SQL para corrigir)
- Admin (configurações): SQL agora cria constraint para capacidade_dia_inteiro (1 ou 2)
- Cadastro: termos de uso e política de privacidade com aceite obrigatório e registro no Supabase
- Público: página /ajuda com contato, FAQ e links para termos/privacidade
- Painel: link “Ajuda” no menu lateral (usuário e funcionário)
- Ajuda: quando autenticado, abre dentro do painel e volta ao dashboard/agenda
- Ajuda: fallback real de suporte (telefone/WhatsApp e email) com links tel/mailto
- Ajuda: WhatsApp mostra número em negrito e email com prefixo "Email:"
- Ajuda: WhatsApp exibido como "WhatsApp: (31) 9 7518-4428"
- Link público: RPC via REST sanitiza VITE_SUPABASE_URL e VITE_SUPABASE_ANON_KEY (remove aspas e barras finais)
- Link público: fallback de assinatura agora remove p_extras quando Supabase está com SQL antigo
- Link público: erro de slots diferencia ausência de public_get_ocupacoes e sugere SQL de ocupações/bloqueios
- Link público: erro de slots/criação em rotas com unidade sugere também SQL de Multi-unidades (EMPRESA)
- Link público: detecção de RPC ausente ficou mais precisa (evita falso-positivo em permission denied)
- Admin (configurações): SQL do link público inclui pgcrypto e NOTIFY pgrst para refresh imediato
- Admin (configurações): SQL do link público remove overload de RPCs e padroniza assinaturas com parâmetros default
- Link público: public_get_usuario_publico agora aceita p_unidade_slug e evita erro de "best candidate function"
- Link público: RPCs públicas agora aceitam p_unidade_id default e salvam agendamentos com unidade_id quando disponível
- Público: ajuste de lint no PublicBookingPage (remove helper não utilizado)
- Link público: hotfix SQL remove overloads de public_create_agendamento_publico (evita PGRST203)
- Clientes: lista e detalhes destacam quando um telefone tem múltiplos nomes
- Cliente (detalhes): ação "Ocultar cliente" anonimiza telefone/nome em todos os agendamentos do número
- Cliente (detalhes): ocultar cliente usa telefone vazio e nome "Cliente oculto" (NOT NULL)
- Trial: período padrão reduzido de 15 para 7 dias (data_vencimento)
- Funcionários: limite agora respeita o plano (enterprise ilimitado; pro 4–6; basic/free 1)
- Edge Functions: create-funcionario/admin-create-funcionario validam limite pelo plano
- Deploy: Edge Functions create-funcionario (v17) e admin-create-funcionario (v1) em ttecpztkoaxwttludgfl
- Funcionários: permissões agora incluem Atendente (além de Funcionário e Gerente)
- Funcionários: rótulo de "Admin" renomeado para "Gerente" (permissao continua 'admin')
- Link público: public_get_funcionarios_publicos filtra para exibir apenas permissao='funcionario'
- Link público: filtro agora exige permissao='funcionario' (não mostra null/gerente/atendente)
- Deploy: Edge Functions create-funcionario (v18) e admin-create-funcionario (v2) em ttecpztkoaxwttludgfl
- Dev (Windows): npm ci estava falhando por lock em binário do Rollup; removido arquivo travado e reinstaladas dependências
- TypeScript: tsconfig.app inclui tipos de React/ReactDOM e composite para remover erros de JSX no editor
- Funcionários: SQL para atualizar constraint funcionarios_permissao_check e permitir permissao='atendente'
- Agenda (painel): filtro de profissionais mostra apenas permissao='funcionario'
- Agenda (funcionário): gerente/atendente com "Ver agenda" podem ver agenda completa com filtro por profissional
- RLS: gerente/atendente com pode_ver_agenda podem listar funcionarios/agendamentos/bloqueios do master
- UI: campos de senha agora têm botão Ver/Ocultar
- Agenda (funcionário): removida edição do próprio horário (apenas gerente ajusta no painel)
- Agenda (atendente): atendente não visualiza o card "Resumo do Dia"
- Admin (configurações): SQL bloqueia RPC funcionario_update_horarios (não permite salvar horário por funcionário)
- Agenda (atendente): agenda completa usa horários do profissional filtrado (slots corretos)
- Agenda (atendente): erros de permissão/RLS exibem mensagem detalhada com ação recomendada
- Agenda (atendente): modo Lista para visualizar agendamentos e bloqueios por período
- Agenda (atendente): vazio agora mostra período, profissional e filtros ativos
- Agenda (painel): preferência Grade/Lista fica salva por usuário no navegador
- Agenda (atendente): exibe erro quando funcionarios.usuario_master_id está vazio (não carrega agenda)
- Supabase RLS: corrigida recursão infinita em policy de funcionarios usando função security definer
- Gerente: Configurações (Mensagens automáticas / Página pública) agora usam usuário master
- Onboarding: gerente usa perfil do usuário master (com estado Carregando…)
- Gerente: acesso agora limitado às 7 permissões (agenda/criar/cancelar/bloquear/financeiro/serviços/clientes)
- Menu: gerente só vê páginas permitidas pelas permissões marcadas
- Painel (agenda): bloquear horário, confirmar/no-show/cancelar e preços respeitam permissões do gerente
- Configurações: Pagamento/Funcionários/WhatsApp/Mensagens/Página pública restritos ao usuário master
- Funcionários: capacidade de diárias por dia só aparece para tipo_negocio=faxina/diarista
- Funcionários: ícone de agendamentos usa tesoura só em barbearia (senão calendário)
- WhatsApp: botão “Conectar (código)” agora prioriza código de pareamento (não QR)
- WhatsApp: UI não exibe QRCode quando o usuário escolhe “Conectar (código)”
- WhatsApp: Edge Function tenta criar/conectar com qrcode=false no modo código
- WhatsApp: ocultado o modo “Conectar (código)” (mantido apenas QR Code)
 - Mensagens automáticas: UI mobile aprimorada (padding responsivo, botões full-width no celular, melhor hierarquia)
 - Mensagens automáticas: adicionados modelos prontos para lava_jatos/barbearia/manicure/pilates/faxina
 - Mensagens automáticas: ao selecionar modelo pronto, aplica confirmação e lembrete automaticamente
 - Página pública (config): removida validação visual do link público (tela mais limpa)
 - Página pública (config): slug duplicado exibe “Nome já está em uso. Escolha outro para o seu link público.”
 - Página pública (config): Unidades ativo apenas no plano enterprise (carrega/permite CRUD só nesse plano)
 - Página pública (config): Aparência permite cores em qualquer plano
 - Página pública (config): Logo e imagem de fundo liberados apenas para planos pro/enterprise (com bloqueio de UI e no salvar)
 - Página pública (config): prévia de aparência agora mostra serviços reais do usuário (Supabase)

2026-01-11 (validação)
- Build (tsc -b + vite build): OK
- Lint (eslint .): OK
- Smoke-test em preview (vite preview): OK (home abre sem erros no browser)
- Varredura por mocks/simulações no front: não encontrado (mock/fake/stub/simula)

2026-01-11 (GitHub)
- Upload realizado para https://github.com/Joecabulo/smagenda (branch main)
- Commit enviado: b273437

2026-01-11 (Cloudflare)
- Hotfix: adicionado package.json na raiz para o Cloudflare Pages encontrar npm scripts
- Build no Cloudflare: "npm run build" (root) gerando artefatos em "dist" (raiz)
- Frontend: Vite outDir ajustado para "../dist" (gera dist na raiz do repositório)
 - Repo: adicionado .gitignore na raiz para ignorar dist/ e logs

2026-01-11 (site)
- Landing page pública adicionada na rota / com CTA para cadastro/login
- Landing page: rodapé usa nome de marca configurável (© {ano} {brand})
- Landing page: seção de diferenciais para posicionamento/exclusividade
- Landing page: botão Copiar usa domínio real (window.location.origin)
- Branding: suporte a VITE_PUBLIC_PRODUCT_NAME, VITE_PUBLIC_COMPANY_NAME e VITE_PUBLIC_COMPANY_LOGO_URL (com fallback)
- Landing page: header exibe empresa (logo/nome) + nome do sistema
- Landing page: seção Para quem é e FAQ
- Site: favicon atualizado para ícone SingleMotion (substitui vite.svg)
- Site: favicon atualizado para usar smagenda/public/favicon.png (logo SingleMotion)

2026-01-12
- Landing page: seção Planos com preços reais (BASIC/PRO/EMPRESA) e CTA para cadastro
- Landing page: destaque de pré-venda com validade até 08/02/2026
- Landing page: CTA “Falar no WhatsApp” usa número real via env (VITE_SUPORTE_WHATSAPP / VITE_SUPPORT_WHATSAPP*)
- Landing page: bloco de confiança (checkout Stripe, cancelamento, suporte) e FAQ com cobrança/comparação de planos
- Validação: lint (eslint .) e build (tsc -b + vite build) OK
- Plano EMPRESA: limite definido para até 10 profissionais (UI + Edge Functions + pagamentos)
- Pagamento: botão “Gerenciar / Cancelar” abre Stripe Billing Portal (assinaturas)
- Auth: UsuarioProfile passa a carregar stripe_customer_id do Supabase
- Validação: lint (eslint .) OK; build (tsc -b + vite build) OK
- Pagamento: erro invalid_action agora orienta deploy da Edge Function payments
- Deploy: Edge Function payments (v16) em ttecpztkoaxwttludgfl
- Deploy: Edge Function payments (v17) com --no-verify-jwt em ttecpztkoaxwttludgfl
- Pagamento: Billing Portal agora retorna mensagem real do Stripe em erros
- Pagamento: suporta STRIPE_BILLING_PORTAL_CONFIGURATION (opcional)
- Deploy: Edge Function payments (v18) em ttecpztkoaxwttludgfl
- Pagamento: Billing Portal recria stripe_customer_id quando cliente não existe no Stripe
- Deploy: Edge Function payments (v19) em ttecpztkoaxwttludgfl
- Pagamento: PIX checkout resolve Price one-time real por plano (STRIPE_PRICE_{PLANO}_PIX ou fallback Stripe API)
- Deploy: Edge Function payments (v20) em ttecpztkoaxwttludgfl

- Roteiro de Vendas: adicionadas situações de venda consultiva (ex.: estúdio de yoga), mensagens prontas e objeções

2026-01-12 (prospector)
- Novo app separado "prospector" para importar estabelecimentos do Google Maps (Places API) por rua/cidade e segmentação
- Prospector: ações por estabelecimento (confirmado/aprovado/recusou/sem resposta/visitado) + contato (nome/número) + exportação JSON/CSV
- Prospector: backend proxy (Express) para chamadas reais ao Google Places (exige GOOGLE_MAPS_API_KEY no server/.env)
- Prospector: UI redesenhada (tema escuro, painel de detalhes, filtros/ordenação, copiar/WhatsApp/tel, multi-ruas)
- Prospector: PWA instalável no Android (manifest + service worker + botão Instalar)
- Prospecção: nova tela /prospeccao para gerenciar estabelecimentos (status, contato, observações)
- Prospecção: Edge Function prospeccao importa estabelecimentos reais do Google Maps/Places por rua/termos
- Prospecção: SQL cria tabela public.prospeccao_estabelecimentos com RLS e índices
- Prospecção: correção de lint na ProspeccaoPage (useCallback e remoção de variável não usada)
- Prospector: botão "Importar Itabirito (cidade inteira)" via Places API real (proxy /api)
- Prospector: ordenação "Rua e número" com separação visual por rua
- Prospector: segmentos agora são persistidos/mesclados durante upsert/importações
- Prospector: api.ts melhora erro quando /api está offline (proxy 500 vazio)
- Prospector-server: carrega GOOGLE_MAPS_API_KEY via server/.env (sem dependências)
- Prospector (dev): iniciado prospector/server (8787) e vite dev (5173) para validar proxy /api
- Prospector: pré-check /api/health bloqueia importação sem GOOGLE_MAPS_API_KEY
- Prospector-server: criado prospector/server/.env placeholder (sem segredo)
- Prospector: preset "Todos (por agendamento)" agrega segmentos e importa em uma passada
- Prospector: barra de progresso com etapa atual durante importações

2026-01-12 (SMagenda)
- Tema alternativo “Prospector” implementado como flag real por usuário (usuarios.tema_prospector_habilitado)
- Super Admin: toggle em /admin/whatsapp para habilitar/desabilitar Tema Prospector em clientes selecionados
- Admin (configurações): novo bloco SQL “SQL do Tema Prospector (habilitação por cliente)” com trigger bloqueando update fora do super admin
- AppShell aplica classe theme-prospector baseado no usuário logado (ou master do gerente), sem alterar tema padrão
- Build: corrigido erro TS5076 na ProspeccaoPage (precedência de ?? e ||)
- Lint: ajustado useEffect da ProspeccaoPage para evitar setState-in-effect
- Tema Prospector: dropdowns/inputs agora usam fundo escuro e texto claro (options legíveis)
- Super Admin: habilitar/desabilitar Tema Prospector movido para /admin/clientes (lista geral)
- Tema Prospector: Auth refresh automático em foco/visibilidade para refletir mudanças de flag
- PWA: SMagenda instalável (manifest + service worker + registro em produção)
- Prospecção: removida do SMagenda (tela/rota/menu/SQL/Edge Function)
- Validação: lint (eslint .) e build (tsc -b + vite build) OK após remoção

2026-01-14 (Prospector deploy)
- Prospector publicado como app separado no caminho /142555787po (Vite base + PWA ajustados)
- Deploy: build da raiz agora gera SMagenda (/) + Prospector (/142555787po) no mesmo dist
- Cloudflare Pages Functions: endpoints /api/* para Google Places/Geocode (sem servidor local)
- Cloudflare Pages Functions: adicionado /api/health para validar hasKey em produção
- Cloudflare redirects: fallback SPA para /142555787po e para /
- Prospector: importação padrão agora é por cidade + estado (UF), cobrindo a cidade inteira
- Prospector: raio de busca derivado do viewport do Geocode (fallback 14km) para resultado real
- Prospector: botão "Excluir tudo" para limpar importes salvos no dispositivo (localStorage)
- Segurança: removido prospector/server/.env do Git (chaves não devem ficar no repo)
- Prospector PWA: service worker não faz cache de /api/* (evita travar hasKey/erros antigos)

2026-01-14 (SMagenda)
- Página pública (config): removido campo de slug; URL pública somente leitura; slug gerado no salvar quando vazio
- Agenda: agendamento público inicia como "pendente"; ao confirmar vira "confirmado" e botão Confirmar some
- Agenda: filtro ganhou campo de Data (type=date) para pular direto para um dia
- Agenda: ao cancelar agendamento, envia aviso real via WhatsApp (Edge Function) e mostra feedback
- Mensagens automáticas: adicionados campo/toggle e modelos prontos de cancelamento (com variáveis reais)
- Admin (configurações): SQL do WhatsApp (automação + config global) inclui enviar_cancelamento e mensagem_cancelamento
- Edge Function whatsapp: envio de cancelamento respeita enviar_cancelamento e mensagem_cancelamento (fallback seguro)
- Mensagens automáticas: botões de “Modelos prontos” agora ficam em grid e com tamanho uniforme
- Link público: janela padrão de agendamento aumentada para 30 dias (mantém override por serviço)
- Link público: seleção de data agora abre calendário popup e preenche a data escolhida

2026-01-22
- Agenda (usuário/funcionário): botão "Ver participantes" aparece para Academia mesmo quando o slot está como "Ocupado" (overlap)
- Agenda (usuário/funcionário): contagem de vagas mostra "Agendados" sempre e "Restantes" quando capacidade_por_horario existe
- Agenda (usuário/funcionário): semana agora mostra 3 dias por linha (layout fixo)
- Agenda (usuário/funcionário): cards semanais mostram só Status, Hora, Cliente e Serviço
- Agenda (usuário/funcionário): semana aplica layout/estilo igual para todos os tipos de negócio
- Validação: smagenda npm run lint OK
- Validação: smagenda npm run build (tsc -b + vite build) OK
- Cadastro: campo "Cupom de convite" (persistido em user_metadata no Supabase Auth)
- Cadastro: diagnóstico do Supabase oculto por padrão (apenas DEV com ?debug=1)
- Onboarding: etapa inicial coleta tipo_negocio e nome da unidade; persiste no Supabase
- Onboarding: removido preload via setState em useEffect; estado inicial vem do perfil no mount (lint OK)
- Auth: usuário com perfil incompleto é redirecionado para /onboarding
- Onboarding: texto da etapa WhatsApp ajustado para refletir habilitação por plano/suporte
- Onboarding: adicionado campo "Endereço do estabelecimento" e persiste em usuarios.endereco + unidades.endereco
- Mensagens automáticas: prévia dos templates com dados reais do agendamento selecionado (mesmas variáveis do envio)

2026-01-15
- Agenda (funcionário): notificação em tempo real quando entrar novo agendamento (Supabase Realtime)
- Agenda (funcionário): botão “Ativar notificações” usa Notification API (fallback visual no topo)
- WhatsApp: Edge Function whatsapp-lembretes aceita action=funcionario_novo_agendamento e envia ao profissional
- Admin (configurações): SQL adiciona trigger para avisar profissional no WhatsApp ao criar/atribuir agendamento
- Funcionários: removido bloco duplicado de botões “Cancelar/Salvar” no formulário
- WhatsApp (app): erro 530 do Cloudflare Tunnel agora mostra mensagem curta com dica de correção

2026-01-15 (validação geral)
- Root: npm run lint OK (smagenda + prospector)
- Root: npm run build OK (smagenda + prospector)
- Link público: removido limite curto e liberado até 1 ano (considera ano bissexto)
- Link público: calendário carrega disponibilidade real apenas do mês visível
- Link público: pagamento com taxa usa hora efetiva também em serviços dia_inteiro
- Link público: calendário popup desabilita dias sem horários disponíveis (consulta RPC real)
- Link público: texto de ajuda abaixo da data atualizado para orientar troca de mês e disponibilidade
- Admin (configurações): SQL do link público agora libera janela de 365 dias nas RPCs (slots/criação)
- Link público: removida seleção automática inicial (serviço/profissional/data) — exige clique do cliente
- Link público: quando data fica inválida, limpa seleção em vez de escolher outra automaticamente
- Link público: botões Continuar/Confirmar com mais destaque e efeito visual no clique
- Link público: pop-up exibido após envio real do agendamento (RPC/pagamento)

2026-01-17
- Documento PDF completo para RAG gerado a partir do repositório (texto de arquivos e configurações)
- Arquivo: SMagenda_RAG_Completo.pdf (raiz do projeto)
- Regras: ignora node_modules/dist/build/.git e redige tokens/chaves com padrão de segredo/JWT
- PDF RAG v2: adicionada seção inicial em linguagem natural (FAQ/fluxos/planos/WhatsApp/pagamento) + apêndice com dump do repositório

2026-01-17
- Regras de negócio: atualizado REGRAS_NEGOCIO_E_FUNCOES_SMAGENDA.txt com detalhes reais de produção
- WhatsApp: documentado whatsapp-lembretes (confirmações em lote, lembretes, avisos de cobrança e aviso ao profissional)
- Pagamentos: documentado checkout PIX (Price one-time por plano) e flag VITE_ENABLE_TAXA_AGENDAMENTO no link público
- Banco: documentado enforcement real por SQL (limite de serviços BASIC/FREE e foto_url somente PRO/TEAM/EMPRESA)
- WhatsApp: documentadas ações admin_* e autenticação de cron (CRON_SECRET / x-cron-secret)
- Regras de negócio: detalhados ENABLE_BOOKING_FEE, config_status e erros whatsapp_disabled/missing_message_data
- WhatsApp (planejamento): ajustadas regras para migração Evolution -> Meta Cloud API (token/phone_number_id/webhook e cobrança por template entregue)

2026-01-17
- WhatsApp: whatsapp-lembretes agora envia também via Meta Cloud API quando configurado no Super Admin
- WhatsApp: whatsapp-lembretes aplica quota mensal (whatsapp_quota_mensal/consumo) também para envios automáticos no provedor Meta
- WhatsApp: whatsapp-lembretes registra outbound em whatsapp_messages via whatsapp_register_outbound (message_id/kind/category)
- Build: corrigido TS1355 no WhatsappSettingsPage (tutorialSteps com as const em literais)
- Root: npm run lint OK (smagenda + prospector)

2026-01-17
- Regras de negócio: documento REGRAS_NEGOCIO_E_FUNCOES_SMAGENDA.txt reformulado para Meta Cloud API como padrão
- WhatsApp: definida quota mensal por plano (FREE 0, BASIC 100, PRO/TEAM 300, EMPRESA 500)
- WhatsApp: definida regra de créditos extras e preços sugeridos (+100/+500/+1000)

2026-01-17
- Docs: CHECKLIST_SISTEMA.md atualizado para Meta Cloud API como padrão (Evolution legado)
- Docs: scheduling-system-doc.md e scheduling-system-doc (1).md atualizados para Meta Cloud API
- Docs: DOCUMENTACAO_MULTI_MODAL.md ajustado para critério de produção com Meta Cloud API
- Docs: gemini.md ajustado para orientar Meta Cloud API (e Evolution somente legado)

2026-01-19
- WhatsApp (Super Admin): /admin/whatsapp salva Meta (token/phone_number_id) e exibe status global (Meta/Evolution) com número oficial/nome verificado
- WhatsApp (Super Admin): ações de QR/conexão ficam restritas ao modo Evolution (Meta não usa instância)
- WhatsApp (Usuário): Configurações > WhatsApp exibe número oficial e nome verificado quando provedor é Meta
- Edge Function whatsapp: config_status (Meta) consulta display_phone_number e verified_name na Graph API
- WhatsApp (reversão): Meta Cloud API fica desativada por padrão via env WHATSAPP_ENABLE_META=false
- WhatsApp (reversão): Edge Functions ignoram config Meta e retornam 404 para webhook Meta quando desativado

2026-01-20
- Cloudflare Tunnel: Evolution público ficou online após connector cloudflared conectar e status sair de Down/1033
- Evolution Manager: credencial é a AUTHENTICATION_API_KEY da Evolution (não é o token do Cloudflare Tunnel)
- Evolution (produção): após trocar AUTHENTICATION_API_KEY/EVOLUTION_AUTH_KEY, reiniciar o serviço
- WhatsApp (reversão): UI de WhatsApp volta a ser Evolution-only (sem campos/estados de Meta)
- Validação: smagenda npm run lint OK; npm run build (tsc -b + vite build) OK
- WhatsApp (BYO Evolution): Edge Functions priorizam usuarios.whatsapp_api_url/whatsapp_api_key por cliente (override da config global)
- WhatsApp (BYO Evolution): Configurações > WhatsApp permite salvar/limpar API URL e API Key do gateway próprio
- WhatsApp (manual/wa.me): Dashboard e Agenda do funcionário abrem link wa.me pré-preenchido quando envio automático está sem gateway (skipped=not_configured)
- WhatsApp (manual/wa.me): Mensagens automáticas abre wa.me no teste quando o envio automático estiver sem gateway
- Docs: criado MANUAL_EVOLUTION_API.md com passo a passo completo de implantação/validação da Evolution API
- Docs: MANUAL_EVOLUTION_API.md inclui seção de teste local com tunnel e limitações
- Docs: MANUAL_EVOLUTION_API.md inclui instalação no Windows (Docker Desktop/WSL2) e cuidados de operação
- Docs: adicionado SMagenda_Evolution_Windows_Installer.ps1 (instalador PowerShell) para automatizar Evolution no Windows
- Windows (Evolution): instalador suporta Quick Tunnel (trycloudflare) para URL pública temporária
- Windows (Evolution): adicionado wrapper SMagenda_Evolution_Windows_Installer.cmd para evitar erro de “cmdlet não reconhecido”
- Windows (Evolution): manual esclarece que Visual Studio não é requisito do instalador (Docker/WSL apenas)
- Docs: MANUAL_EVOLUTION_API.md inclui instruções Linux quando curl não está instalado (curl/wget/apt)
- Ubuntu (Evolution): adicionado smagenda-evolution-ubuntu-install.sh para instalar Docker + subir Evolution + Cloudflare Tunnel fixo
- WhatsApp (Super Admin): habilitação do WhatsApp por cliente não bloqueia mais quando a config global está pendente (compatível com BYO)
- Ubuntu (Evolution): instalador preserva API key e senha do Postgres em reruns (evita quebrar volume)
- Ubuntu (Evolution): instalador copia log automaticamente para install.log no diretório de instalação
- Ubuntu (Evolution): .env gerado com permissão restrita (umask 077)
- Ubuntu (Evolution): parâmetro --api-key agora sobrescreve valor do .env existente
- Ubuntu (Evolution): instalador aceita --quick-tunnel (trycloudflare) sem token, com URL temporária
- Ubuntu (Evolution): instalador aceita --no-tunnel para uso apenas local (sem URL pública)
- Ubuntu (Evolution): compose inclui cloudflared somente quando modo túnel fixo está ativo
- Auth: refresh token inválido agora força signOut local para parar loop de erro no console
- Super Admin (WhatsApp): salvar config não usa mais upsert que inseria email nulo
- WhatsApp (Usuário): ocultado bloco “Meu gateway (Evolution)” (sem BYO por usuário)
- Edge Function whatsapp: não usa mais usuarios.whatsapp_api_url/whatsapp_api_key (usa só config global)
- Cloudflare Tunnel (operação): cloudflared deve rodar com restart policy para subir após quedas
- Clone Evolution: criada pasta clone-evo-config com cópia dos arquivos da integração (UI + Edge Functions + infra)

2026-01-21
- WhatsApp (Edge Function): tipagem do client ajustada para destravar rpc com args (sem mocks)
- WhatsApp (Edge Function): tipagem de headers/content-type normalizada para Record<string,string>
- Payments (Edge Function): tipagem do client ajustada para destravar rpc com args (sem mocks)
- WhatsApp-lembretes (Edge Function): tipagem de headers/content-type normalizada para Record<string,string>
- Página pública (config): tipo_negocio inclui opção "Advocacia" (valor: advocacia)
- Página pública (agendamento): labels de tipo_negocio=advocacia (Consulta/Advogado)
- Validação: smagenda npm run lint OK; npm run build OK
- Billing: trial expirado agora marca usuarios.ativo=false e desativa funcionarios do master
- Payments: sync de checkout expande payment_intent e atualiza status_pagamento/plano ao pagar
- Payments: Billing Portal resolve customer por email e prioriza customer com invoices/subscriptions
- Payments: checkout one-time cria invoice e define receipt_email para recibo por email
- Pagamento (UI): pós-success faz sync+refresh com retry para refletir plano ativo
- Super Admin: nova página /admin/pagamentos com lista de clientes e ação de cancelamento
- Payments (Edge Function): action cancel_subscription (Stripe cancel_at_period_end) para super admin
- Super Admin (Pagamentos): status/plano/data_vencimento consultados no Stripe (fallback DB quando necessário)
- Payments (Edge Function): action admin_get_usuario_stripe_status consulta subscription/invoice no Stripe
- Payments (Edge Function): admin_get_usuario_stripe_status permite o usuário consultar o próprio status
- Payments (Edge Function): admin_get_usuario_stripe_status persiste plano/status/vencimento vindos do Stripe
- Payments (Edge Function): cancel_subscription suporta cancelamento imediato via Stripe (DELETE)
- Super Admin (Pagamentos): corrigido loop infinito em plano/status; sync ao abrir e no Recarregar
- Banco (Pagamentos): colunas usuarios.data_pagamento_fatura e usuarios.stripe_last_invoice_id
- Banco (Pagamentos): RPC get_usuario_data_pagamento_fatura com acesso user/super admin
- Payments (Edge Function): persiste data_pagamento_fatura via Stripe Invoice e recalcula data_vencimento (+30 dias)

2026-01-22
- Payments (Edge Function): grant_free_months recria assinatura cancelada para aplicar cupom/desconto no Stripe
- Admin (cliente detalhes): botão “Atualizar status” sincroniza com Stripe e auto-preenche plano/status (mantém editável)
- Super Admin (UI): toggle de Tema Prospector no header (salvo no navegador)
- App (UI): toggle Dark/Claro ao lado do botão Sair (salva no DB e no navegador)
- Usuário (Página pública): adicionado tipo de negócio "Advocacia" na lista
- Super Admin (Pagamentos): dias restantes calculados por data_pagamento_fatura (30 dias da compra)
- Pagamento (UI): mostra dias p/ vencer (30 dias após compra) usando RPC do banco
- Payments (Edge Function): action pause_subscription pausa cobrança via Stripe pause_collection
- Pagamento (UI): botão “Pausar assinatura” chama Stripe e atualiza status via refresh
- Payments (Edge Function): action grant_free_months cria cupom 100% e aplica na subscription
- Academia: serviços suportam capacidade_por_horario (clientes por horário)
- Link público: lista horários com vagas_restantes e envia p_qtd_vagas na criação
- Banco/RPC: agendamentos.qtd_vagas + lock transacional evitam overbooking por horário
- Pagamento (taxa): Edge Function payments respeita qtd_vagas ao criar agendamento público
- Link público: mensagem amigável para erro capacidade_esgotada (sem overbooking)
- Payments (Edge Function): retorna 409 em capacidade_esgotada na criação do agendamento
- Agenda (painel/funcionário): fallback quando coluna agendamentos.qtd_vagas não existe
- Payments (Edge Function): grant_free_months aceita cupom/promoção (promo_/code/coupon) e aplica desconto real
- Super Admin (Pagamentos): entrada de meses grátis aceita cupom/promoção via modal (sem prompt)
- Payments (Edge Function): grant_free_months faz fallback promo->coupon e melhora mensagens de erro
- Payments (Edge Function): grant_free_months estende trial no banco quando não há assinatura
- Super Admin (Pagamentos): botão Meses grátis também estende trial sem assinatura (meses 1–24)
- Super Admin (Pagamentos): fallback de estender trial direto no banco quando payments está desatualizada
- Payments (Edge Function): invalid_action agora retorna versão e ações suportadas
- Deploy: Edge Function payments (v21) em ttecpztkoaxwttludgfl
- Super Admin (Pagamentos): ação “Meses grátis” aplica desconto por N meses no Stripe
- Pagamentos: meses grátis aceita aplicar cupom existente (ex.: uvRxedCK)
- Super Admin (Pagamentos): removido prompt/confirm; modal compatível com preview
- Super Admin (Pagamentos): callFn faz refresh de JWT e detecta token de outro projeto (evita invalid jwt)
- Super Admin (Pagamentos): build TS corrigido no callFn (envValues evita erro de narrow do supabaseEnv)
- Auth: refresh global valida issuer do JWT por projeto e força signOut local quando mismatch (evita invalid jwt)
- Auth (tipos): UsuarioProfile agora inclui data_pagamento_fatura
- Supabase (lib): exporta supabasePublicUrl/supabasePublicAnonKey sanitizados (sem aspas/barras)
- Super Admin (Pagamentos): chamadas de Edge Function usam supabasePublic* (evita invalid jwt por env com aspas)
- Deploy: hotfix invalid jwt (Edge Functions) enviado para GitHub/Cloudflare (main)
- Payments (Edge Function): cancel_subscription permite o próprio usuário (não só Super Admin)
- Pagamento (UI): botão “Gerenciar / Cancelar” aparece mesmo sem stripe_customer_id (quando ativo)
- Payments (Edge Function): sync_checkout_session retorna erro quando persistência no DB falha
- Payments (Edge Function): status_pagamento=ativo reativa usuarios.ativo=true automaticamente
- Super Admin (Pagamentos): meses grátis sempre chama Edge Function payments (sem update direto)
- Deploy: Edge Function payments (v22) em ttecpztkoaxwttludgfl (--no-verify-jwt)
- Super Admin: rota e menu /admin/pagamentos ativados (AdminPagamentosPage)
- Validação: npm run lint + npm run build OK (smagenda)
- Root: npm run build OK (smagenda + prospector)
- Mensagens automáticas: adicionado modelo pronto "Advocacia" (confirmação/lembrete/cancelamento)
- Mensagens automáticas: adicionados modelos prontos "Advocacia" e "Academia"
- Página pública (config): tipo de negócio "Academia" adicionado no combo
- Link público: rótulos de Academia (Aula/Instrutor) no agendamento público
- Serviços: "Buffer antes/depois (min)" renomeado para "Tempo extra antes/depois (min)"
- Clientes: indicador de no-show no card (círculo vermelho no canto)

2026-01-22
- Payments (Edge Function): grant_free_months recria assinatura cancelada para aplicar cupom/desconto
- Admin (cliente detalhes): botão “Atualizar status” sincroniza com Stripe via payments e atualiza plano/status no formulário
- Link público: public_get_ocupacoes usa duracao_minutos quando hora_fim está vazio
- Academia (link público): vagas_restantes usa mínimo por bloco (30min) na duração
- Academia (criação pública): valida capacidade por horário em toda a duração (lock transacional)
